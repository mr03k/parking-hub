apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: pg-vehicle-record
  namespace: uat
spec:
  # backup:
  #   barmanObjectStore:
  #     destinationPath: s3://db-backups
  #     endpointURL: https://z10.s3.cloud.ir
  #     s3Credentials:
  #       accessKeyId:
  #         key: S3_ACCESS_KEY
  #         name: s3-backup-secret
  #       secretAccessKey:
  #         key: S3_SECRET_KEY
  #         name: s3-backup-secret
  #   retentionPolicy: "10d"
  instances: 1
  imageName: ghcr.io/cloudnative-pg/postgis:16-3.5-114
  storage:
    size: 20Gi
  managed:
    services:
      additional:
      - selectorType: rw
        updateStrategy: replace
        serviceTemplate:
          metadata:
            name: "pg-vehicle-record-nodeport"
          spec:
            type: NodePort
    roles:
    - name: aban
      ensure: present
      comment: aban
      login: true
      superuser: true
      inherit: true
      connectionLimit: -1
      inRoles:
      - pg_monitor
      - pg_signal_backend
    - name: bi_user
      ensure: present
      comment: b
      login: true
      inherit: true
      connectionLimit: 20
      inRoles:
      - pg_monitor
      - pg_signal_backend
      passwordSecret:
        name: postgres-bi-user-secret
  bootstrap:
   initdb:
     database: vehicle_records # Name of the initial database
     owner: aban               # Owner of the database
     secret:
       name: postgres-user-secret # Secret containing password
     postInitApplicationSQL:
     - GRANT CONNECT ON DATABASE vehicle_records TO bi_user;
     - GRANT USAGE ON SCHEMA public TO bi_user;
     - GRANT SELECT ON ALL TABLES IN SCHEMA public TO bi_user;
     - ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO bi_user;
